## Context

当前项目是一个面向 Trino 的查询编辑器，前端通过既有后端 API 执行查询、轮询状态、获取结果与元数据。目标是将后端对接从 Trino 切换为 AWS Athena API，并允许根据 Athena 特性对 UI 交互进行合理调整以保证可用性。
后端将新增在本仓库 `server/` 目录，使用 Express + TypeScript，并由 oauth2-proxy 注入 `X-Email` 做用户隔离。

## Goals / Non-Goals

**Goals:**
- 使用 Athena API 完成查询执行、状态轮询、结果与元数据获取
- 支持 Athena 的异步查询模型，并在 UI 中映射为一致的状态与错误展示
- 提供 Athena 所需的连接与认证配置（区域、工作组、S3 输出位置等）
- 尽量最小化 UI 交互变更，复用当前编辑与结果展示体验

**Non-Goals:**
- 新增与 Athena 无关的查询能力或编辑器功能
- 实现复杂的多租户/多账号身份代理（除非现有系统已有）
- 对结果进行新的数据分析或可视化能力扩展

## Decisions

1) **后端接入方式：以服务端适配器替换 Trino 客户端**
   - 采用 AWS SDK（或等价封装）在后端实现 Athena 调用，统一由后端对外提供现有 API 协议或其最小变更版本。
   - 原因：避免前端直接访问 AWS 凭证与 S3；降低安全风险；便于集中处理异步状态与分页。
   - 备选：前端直连 AWS SDK + Cognito/STS。放弃原因：权限与安全复杂度高、需要前端处理更多流程。

2) **查询生命周期映射**
   - StartQueryExecution → 生成 queryExecutionId
   - GetQueryExecution 轮询状态（QUEUED/RUNNING/SUCCEEDED/FAILED/CANCELLED）
   - 将 Athena 状态映射到 UI 现有状态（running/success/failed/cancelled）
   - 轮询使用指数退避或固定间隔并设置超时上限
   - 原因：Athena 为异步模型，必须通过轮询获取状态。

3) **结果获取策略：后端统一拉取并分页**
   - 使用 GetQueryResults 分页拉取，后端聚合或逐页转发给前端
   - 对大结果集设置分页与最大行数限制（默认 100，最大 1000）
   - 原因：避免前端直接读取 S3 输出；统一性能与权限控制。
   - 备选：返回 S3 输出地址让前端直接下载。放弃原因：前端需处理签名与权限。

4) **S3 全量结果下载**
   - 查询结果文件以 query execution id 命名（如 `<id>.csv` / `<id>.txt`）
   - 通过后端生成 24h 有效的 presigned URL，支持重复生成
   - 对于失败/取消查询，若 S3 已产生部分结果则允许下载并标注为 partial

4) **认证与配置策略：部署级配置优先**
   - 通过后端环境变量或配置文件提供 AWS 凭证、区域、工作组、S3 输出位置
   - 支持默认数据库/目录（catalog、database）配置
   - 原因：与当前部署方式一致，减少 UI 配置复杂度与用户门槛。

5) **查询历史持久化**
   - 查询历史按用户维度持久化（用户身份来自 oauth2-proxy 注入的 `X-Email`）
   - 取消后的记录长期保留
   - 存储选型：PostgreSQL
   - 原因：满足长期可追溯与审计需求，避免丢失已执行/已取消记录

6) **统计与成本展示**
   - 统计项全程展示：排队时间、执行时间、扫描量、费用
   - 时间单位使用秒（保留两位小数），扫描量使用 GB（保留两位小数）
   - 费用按 region 价格配置与扫描量估算（配置文件：`server/config/athena-pricing.json`）

7) **超时与取消**
   - 轮询间隔 1s，最长 24h，超时后后端取消查询并返回超时状态

8) **用户身份与隔离**
   - oauth2-proxy 注入 `X-Email`，后端以该字段作为用户身份
   - 用户级别隔离查询历史与结果

## Risks / Trade-offs

- [异步查询延迟导致 UI 等待时间增加] → 轮询退避策略 + 显示预计等待提示
- [Athena 成本受查询与结果大小影响] → 增加结果行数上限与提示
- [S3 输出权限不足导致查询失败] → 启动前校验配置并在错误中提示具体权限项
- [不同 Athena 区域/工作组配置混乱] → 明确配置来源与 UI 展示当前配置
- [大结果集分页性能问题] → 后端分页缓存与限制最大页数

## Migration Plan

1) 后端新增 Athena 适配器，实现查询执行、状态轮询、结果与元数据获取
2) 增加配置项（区域、工作组、S3 输出位置、凭证来源）
3) 在测试环境验证：状态映射、错误处理、分页结果准确性、统计显示与超时处理
4) 逐步将生产切换到 Athena

## Open Questions

- AWS 凭证来源是什么？(IAM role / Access Key / STS / SSO)
- 是否需要支持按用户/会话级别选择区域、工作组、数据库？
- 用户身份来源与传递方式如何定义？（已定：oauth2-proxy 注入 `X-Email`）
- 查询历史保留策略是否需要应用层清理？（已定：应用层不清理，由 DB 策略控制）
